<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="main.css" />
<link rel="next" title="全文検索機能の作成" href="ch05.html" /><link rel="prev" title="作成する全文検索システムの概要" href="ch03.html" />  <meta name="generator" content="Re:VIEW" />
  <title>データ入力機能の作成 | Groongaではじめる全文検索</title>
</head>
<body>
  <div class="book">
    <nav class="side-content">
      <h1>Groongaではじめる全文検索</h1>
      <ul class="book-toc">
<li><a href="index.html">TOP</a></li>
<li><a href="intro.html">MySQLで作る全文検索システム</a></li>
<li><a href="ch01.html">第1章　Mroongaの概要</a></li>
<li><a href="ch02.html">第2章　Mroongaの環境の準備</a></li>
<li><a href="ch03.html">第3章　作成する全文検索システムの概要</a></li>
<li><a href="ch04.html">第4章　データ入力機能の作成</a></li>
<li><a href="ch05.html">第5章　全文検索機能の作成</a></li>
<li><a href="ch06.html">第6章　Mroongaならではの機能の作成</a></li>
<li><a href="appendix.html">付録A　付録</a></li>
</ul>
      <p class="review-signature">powered by <a href="http://reviewml.org/">Re:VIEW</a></p>
    </nav>
    <div class="book-body">
      <header>
      </header>
      <div class="book-page">
        <h1><a id="h4"></a><span class="secno">第4章　</span>データ入力機能の作成</h1>
<p>ここからアプリケーションを作っていきます。始めから検索機能に着手したいところですが、データがないことには何もできないので、入力機能から作成します。</p>
<p>PDFファイルの内容をMySQLに登録するために、以下のようなステップを踏むことになります。</p>
<ol>
<li>PHPによるウェブUIから一時ディレクトリーにアップロードする</li>
<li>PDFファイルからタイトルと本文テキストを抽出する</li>
<li>タイトルと本文をMySQLの適切なカラムに挿入する</li>
</ol>

<h2><a id="h4-1"></a><span class="secno">4.1　</span>PDFのアップロード機能を作る</h2>
<p>まずはPDFのアップロード機能を作りましょう。PDFファイルその物は後で使うことはないので、一時ディレクトリーに置いたままで構いません。</p>
<p>ユーザーが表示させる起点の画面をindex.php、そのファイルから呼び出すアップロード機能の部分をupload.phpとして実装することにします。</p>
<div id="id_ch04_2Fupload_2Findex.php" class="caption-code">
<p class="caption">リスト4.1: index.php</p>
<pre class="list language-php highlight"><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/upload.php'</span><span class="p">;</span>

<span class="k">function</span> <span class="n">h</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$flags</span> <span class="o">=</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="nv">$encoding</span> <span class="o">=</span> <span class="s1">'UTF-8'</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$flags</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'POST'</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'pdf'</span><span class="p">,</span> <span class="nv">$_FILES</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$uploads</span> <span class="o">=</span> <span class="nc">\PDFSearch\Upload</span><span class="o">::</span><span class="nf">fromFilesInfo</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'pdf'</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">?&gt;&lt;!doctype html&gt;</span>
<span class="nt">&lt;title&gt;</span>PDF Search<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;h1&gt;</span>PDF Search<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;h2&gt;</span>アップロードされたファイル<span class="nt">&lt;/h2&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$uploads</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$uploads</span> <span class="k">as</span> <span class="nv">$upload</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;p&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">());</span> <span class="cp">?&gt;</span><span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"pdf[]"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">multiple</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre>
</div>
<div id="id_ch04_2Fupload_2Fupload.php" class="caption-code">
<p class="caption">リスト4.2: upload.php</p>
<pre class="list language-php highlight"><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">PDFSearch</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Upload</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$tmpName</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromFilesInfo</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$info</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$uploads</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$fileCount</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$info</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$fileCount</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'name'</span><span class="p">][</span><span class="nv">$i</span><span class="p">];</span>
            <span class="nv">$tmpName</span> <span class="o">=</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'tmp_name'</span><span class="p">][</span><span class="nv">$i</span><span class="p">];</span>
            <span class="nv">$uploads</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Upload</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$tmpName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$uploads</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$tmpName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tmpName</span> <span class="o">=</span> <span class="nv">$tmpName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
<p>今の所、単にアップロードされたファイルの名前を表示しているだけです。後でその他の機能を実装していきます。複数のファイルをアップロードすると<a id="fnb-multi-select" href="#fn-multi-select" class="noteref" epub:type="noteref">*1</a>、全てが表示されることも確認してみてください。</p>
<div id="upload" class="image">
<img src="images/ch04/upload.png" alt="ファイルアップロード画面" />
<p class="caption">
図4.1: ファイルアップロード画面
</p>
</div>
<p>紙幅を減らすため、細かな検証は省略しています。実際に運用するアプリケーションでは安全性やエラーのチェックなどをしっかりと行ってください。</p>
<p>また、エラーが表示されてしまった場合などPHPのでバッグが必要な場合は、本書末尾の<a href="appendix.html#hA-6">「A.6 PHPのデバッグ」</a>にデバッグ方法を記していますので、参考にされてください。</p>
<div class="footnote" epub:type="footnote" id="fn-multi-select"><p class="footnote">[*1] ファイル選択ダイアログでCtrlキーを押しながらファイルをクリックしていくことで、選んだファイルを同時にアップロードできます。また、Shiftを押しながら最初のファイルと最後のファイルをクリックすることで、その間にあるファイルをすべて選択状態にできます。なお、PHPの設定により、合計で1GiBを超えるアップロードは失敗します。</p></div>

<h2><a id="h4-2"></a><span class="secno">4.2　</span>PDFからの情報を抽出する</h2>
<p>次に、PDFファイルからタイトルと本文を抜き出す処理を実装します。これを行うにはいくつか方法がありますが、ここでは<a href="https://github.com/php-poppler/php-poppler" class="link">php-poppler</a>というライブラリーを使うことにします。php-popplerを使うとPDFを解析してタイトルや本文を抜き出すことができます<a id="fnb-poppler" href="#fn-poppler" class="noteref" epub:type="noteref">*2</a>。</p>
<p>php-popplerは<code class="inline-code tt">Poppler</code>名前空間にいくつかのクラスを定義しており、以下のようにして使います。</p>
<div class="emlist-code">
<p class="caption">php-popplerの基本的な使い方</p>
<pre class="emlist language-php highlight"><span class="cp">&lt;?php</span>

<span class="c1">// pdfinfoコマンドのラッパー</span>
<span class="nv">$pdfinfo</span> <span class="o">=</span> <span class="nc">\Poppler\Driver\Pdfinfo</span><span class="o">::</span><span class="nf">create</span><span class="p">();</span>
<span class="c1">// pdftotextコマンドのラッパー</span>
<span class="nv">$pdftotext</span> <span class="o">=</span> <span class="nc">\Poppler\Driver\Pdftotext</span><span class="o">::</span><span class="nf">create</span><span class="p">();</span>
<span class="c1">// pdftohtmlコマンドのラッパー</span>
<span class="nv">$pdftohtml</span> <span class="o">=</span> <span class="nc">\Poppler\Driver\Pdftohtml</span><span class="o">::</span><span class="nf">create</span><span class="p">();</span>

<span class="nv">$pdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\Poppler\Processer\Pdffile</span><span class="p">(</span><span class="nv">$pdfinfo</span><span class="p">,</span> <span class="nv">$pdftotet</span><span class="p">,</span> <span class="nv">$peftohtml</span><span class="p">);</span>

<span class="c1">// PDFからタイトルや著者、作成日時などの情報を連想配列として抜き出す</span>
<span class="k">echo</span> <span class="nv">$pdf</span><span class="o">-&gt;</span><span class="nf">getInfo</span><span class="p">(</span><span class="s1">'path/to/document.pdf'</span><span class="p">);</span>
<span class="c1">// PDFから本文テキストを抜き出す</span>
<span class="k">echo</span> <span class="nv">$pdf</span><span class="o">-&gt;</span><span class="nf">toText</span><span class="p">(</span><span class="s1">'path/to/document.pdf'</span><span class="p">);</span>
</pre>
</div>
<p>HTML関連の機能を使わないとしても、<code class="inline-code tt">\Poppler\Processer\Pdffile</code>のコンストラクターには<code class="inline-code tt">\Poppler\Driver\Pdftohtml</code>のインスタンスを渡す必要があるので注意してください。</p>
<p>Dockerイメージの中には、既にPopplerとphp-popplerがインストール済みです。php-popplerはComposerでインストールしているので、<code class="inline-code tt">vendor/autoload.php</code>を読み込むことで、オートロードが有効になります。</p>
<p>これを使って、先ほど作った<code class="inline-code tt">\PDFSearch\Upload</code>クラスにPDF関連の機能を追加します。</p>
<div id="id_ch04_2Fextract_2Fupload.php" class="caption-code">
<p class="caption">リスト4.3: upload.php</p>
<pre class="list language-php highlight"><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">PDFSearch</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Upload</span>
<span class="p">{</span>
    <span class="c1">// :</span>
    <span class="c1">// （省略）</span>
    <span class="c1">// :</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$tmpName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tmpName</span> <span class="o">=</span> <span class="nv">$tmpName</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\Poppler\Processor\PdfFile</span><span class="p">(</span>
          <span class="nc">\Poppler\Driver\Pdfinfo</span><span class="o">::</span><span class="nf">create</span><span class="p">(),</span>
          <span class="nc">\Poppler\Driver\Pdftotext</span><span class="o">::</span><span class="nf">create</span><span class="p">(),</span>
          <span class="nc">\Poppler\Driver\Pdftohtml</span><span class="o">::</span><span class="nf">create</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// :</span>
    <span class="c1">// （省略）</span>
    <span class="c1">// :</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getTitle</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$info</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdf</span><span class="o">-&gt;</span><span class="nf">getInfo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tmpName</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$info</span><span class="p">[</span><span class="s1">'Title'</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getContent</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdf</span><span class="o">-&gt;</span><span class="nf">toText</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tmpName</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
<p>これに合わせ、index.phpの方も少し変更します。</p>
<div id="id_ch04_2Fextract_2Findex.php" class="caption-code">
<p class="caption">リスト4.4: index.php</p>
<pre class="list language-php highlight"><span class="cp">&lt;?php</span>
<span class="c1">// Dockerイメージ内にComposerでインストール済みのライブラリーを読み込む</span>
<span class="k">require_once</span> <span class="s1">'vendor/autoload.php'</span><span class="p">;</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/upload.php'</span><span class="p">;</span>
    <span class="c1">// :</span>
    <span class="c1">// （省略）</span>
    <span class="c1">// :</span>
<span class="o">&lt;?</span><span class="n">php</span> <span class="c1">// getName()をgetTitle()に変更します。 ?&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;&lt;?</span><span class="n">php</span> <span class="k">echo</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">());</span> <span class="cp">?&gt;</span>(<span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">());</span> <span class="cp">?&gt;</span>)<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nf">h</span><span class="p">(</span><span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getContent</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="ni">&amp;hellip;&amp;hellip;</span><span class="nt">&lt;/p&gt;</span>
    // :
    // （省略）
    // :
</pre>
</div>
<p>実際にPDFファイルをアップロードして、タイトルなどの情報が取得できているか確認しましょう。</p>
<div id="extract" class="image">
<img src="images/ch04/extract.png" alt="PDF内の情報を取得" />
<p class="caption">
図4.2: PDF内の情報を取得
</p>
</div>
<div class="footnote" epub:type="footnote" id="fn-poppler"><p class="footnote">[*2] C製のPDFライブラリーでPopplerという物があり、PDFを扱う様々なコマンドラインツールの提供もしています。php-popplerはこれらのコマンド呼び出しをラップしてPHPから扱いやすくした物です。</p></div>

<h2><a id="h4-3"></a><span class="secno">4.3　</span>データベースにデータを挿入する</h2>
<p>それでは、いよいよMroongaにデータを入力しましょう。と言っても、いつも通り<code class="inline-code tt">PDO</code>クラスで<code class="inline-code tt">INSERT</code>文を実行するだけです。Mroongaの方で自動的に検索用のインデックスを作成してくれます。Dockerイメージ内に既にMySQL用のアダプターはインストールされていますので、単にPHPから呼び出すだけで使用できます。</p>
<p>データ挿入に必要なMySQLのデータベースとテーブルは、コンテナの中に既に作成してあります。構造は以下の通りです。</p>
<div class="emlist-code">
<p class="caption">テーブル作成時の全文検索インデックスの作成</p>
<pre class="emlist language-SQL highlight">CREATE TABLE `pdfs` (
    id      INT PRIMARY KEY AUTO_INCREMENT,
    file    VARCHAR(255),
    title   VARCHAR(255),
    content LONGTEXT,
    FULLTEXT INDEX (title, content)
) ENGINE = Mroonga DEFAULT CHARSET utf8;
</pre>
</div>
<p><code class="inline-code tt">FULLTEXT INDEX</code>や<code class="inline-code tt">ENGINE = Mroonga</code>については後述しますので、ここではカラム定義に注目してください。</p>
<p>このテーブルを扱う<code class="inline-code tt">\PDFSearch\Table</code>クラスを実装し、<code class="inline-code tt">index.php</code>でそのクラスを使うようにしたのが以下の内容です。<code class="inline-code tt">\PDFSearch\Upload</code>には変更がないため省略しています。</p>
<div id="id_ch04_2Finsert_2Findex.php" class="caption-code">
<p class="caption">リスト4.5: index.php</p>
<pre class="list language-php highlight"><span class="cp">&lt;?php</span>
<span class="c1">// Dockerイメージ内にComposerでインストール済みのライブラリーを読み込む</span>
<span class="k">require_once</span> <span class="s1">'vendor/autoload.php'</span><span class="p">;</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/upload.php'</span><span class="p">;</span>
<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/table.php'</span><span class="p">;</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">'DBNAME'</span><span class="p">,</span> <span class="s1">'pdfsearch'</span><span class="p">);</span>

<span class="nv">$dsn</span> <span class="o">=</span> <span class="s1">'mysql:host=localhost;dbname='</span> <span class="mf">.</span> <span class="no">DBNAME</span> <span class="mf">.</span> <span class="s1">';charset=utf8'</span><span class="p">;</span>
<span class="nv">$table</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\PDFSearch\Table</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="s1">'root'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>

<span class="k">function</span> <span class="n">h</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$flags</span> <span class="o">=</span> <span class="no">ENT_QUOTES</span><span class="p">,</span> <span class="nv">$encoding</span> <span class="o">=</span> <span class="s1">'UTF-8'</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$flags</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'POST'</span> <span class="o">&amp;&amp;</span>
    <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'pdf'</span><span class="p">,</span> <span class="nv">$_FILES</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$uploads</span> <span class="o">=</span> <span class="nc">\PDFSearch\Upload</span><span class="o">::</span><span class="nf">fromFilesInfo</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'pdf'</span><span class="p">]);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$uploads</span> <span class="k">as</span> <span class="nv">$upload</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">insert</span><span class="p">(</span><span class="nv">$upload</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: .'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">\RuntimeException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'HTTP'</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'content-type: text/plain'</span><span class="p">);</span>
        <span class="k">echo</span> <span class="nv">$e</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$records</span> <span class="o">=</span> <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">records</span><span class="p">();</span>

<span class="cp">?&gt;&lt;!doctype html&gt;</span>
<span class="nt">&lt;title&gt;</span>PDF Search<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;h1&gt;</span>PDF Search<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;h2&gt;</span>登録済みPDF一覧<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>ファイル名<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>タイトル<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>内容<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$records</span> <span class="k">as</span> <span class="nv">$record</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$record</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nf">h</span><span class="p">(</span><span class="nv">$record</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nf">h</span><span class="p">(</span><span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$record</span><span class="p">[</span><span class="s1">'content'</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">));</span> <span class="cp">?&gt;</span><span class="ni">&amp;hellip;&amp;hellip;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="cp">&lt;?php</span> <span class="k">endforeach</span><span class="p">;</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;form</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"pdf[]"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">multiple</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre>
</div>
<div id="id_ch04_2Finsert_2Ftable.php" class="caption-code">
<p class="caption">リスト4.6: table.php</p>
<pre class="list language-php highlight"><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">PDFSearch</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Table</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">INSERT</span> <span class="o">=</span>
        <span class="s2">"INSERT INTO `pdfs` (file, title, content)
         VALUES(:file, :title, :content);"</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">SELECT</span> <span class="o">=</span> <span class="s2">"SELECT * FROM `pdfs` ORDER BY `id`;"</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$pdo</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\PDO</span><span class="p">(</span><span class="nv">$dsn</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">insert</span><span class="p">(</span><span class="kt">Upload</span> <span class="nv">$upload</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">':file'</span>    <span class="o">=&gt;</span> <span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">(),</span>
            <span class="s1">':title'</span>   <span class="o">=&gt;</span> <span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">(),</span>
            <span class="s1">':content'</span> <span class="o">=&gt;</span> <span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getContent</span><span class="p">()</span>
        <span class="p">];</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="no">INSERT</span><span class="p">);</span>
        <span class="nv">$isSucceeded</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$isSucceeded</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">\RuntimeException</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="kc">PHP_EOL</span><span class="p">,</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">errorInfo</span><span class="p">()));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">records</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="no">SELECT</span><span class="p">);</span>
        <span class="nv">$isSucceeded</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$isSucceeded</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">\RuntimeException</span><span class="p">(</span><span class="nb">implode</span><span class="p">(</span><span class="kc">PHP_EOL</span><span class="p">,</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">errorInfo</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="nf">fetchAll</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
<p>ウェブブラウザーでアクセスして、データベースの中身を表示してみましょう。</p>
<div id="insert" class="image">
<img src="images/ch04/insert.png" alt="アップロードしたPDFの情報を表示" />
<p class="caption">
図4.3: アップロードしたPDFの情報を表示
</p>
</div>
      </div>
      <nav class="book-navi book-prev">
                <a href="ch03.html">
          <div class="book-cursor"><span class="cursor-prev">◀</span></div>
        </a>
              </nav>
      <nav class="book-navi book-next">
                <a href="ch05.html">
          <div class="book-cursor"><span class="cursor-next">▶</span></div>
        </a>
              </nav>
    </div>
  </div>
  <footer>
      </footer>
</body>
</html>
