<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="main.css" />
<link rel="prev" title="Mroongaならではの機能の作成" href="ch06.html">  <meta name="generator" content="Re:VIEW" />
  <title>付録 | Groongaではじめる全文検索</title>
</head>
<body>
  <div class="book">
    <nav class="side-content">
      <h1>Groongaではじめる全文検索</h1>
      <ul class="book-toc">
<li><a href="index.html">TOP</a></li>
<li><a href="./intro.html">MySQLで作る全文検索システム</a></li>
<li><a href="./ch01.html">1 Mroongaの概要</a></li>
<li><a href="./ch02.html">2 Mroongaの環境の準備</a></li>
<li><a href="./ch03.html">3 作成する全文検索システムの概要</a></li>
<li><a href="./ch04.html">4 データ入力機能の作成</a></li>
<li><a href="./ch05.html">5 全文検索機能の作成</a></li>
<li><a href="./ch06.html">6 Mroongaならではの機能の作成</a></li>
<li><a href="./appendix.html">付録</a></li>
</ul>
      <p class="review-signature">powered by <a href="http://reviewml.org/">Re:VIEW</a></p>
    </nav>
    <div class="book-body">
      <header>
      </header>
      <div class="book-page">
        <h1><a id="hA"></a><span class="secno">付録A　</span>付録</h1>

<h2><a id="hA-1"></a><span class="secno">A.1　</span>Mroongaのインストール</h2>
<p>Mroongaを使った全文検索システムに興味が出て来たら、ぜひ自分でインストールしてみてください。以下に、典型的なインストール方法をご案内します。</p>

<h3><a id="hA-1-1"></a>Debian/GNU Linux</h3>
<p>Groongaプロジェクト（？）は、本書執筆時点でDebian/GNU Linux jessieのAPT用のリポジトリーを持っており、Mroongaもそこからインストールできます。サンプルで用いたDockerイメージでもこのパッケージを使用しています。</p>
<p>まず、以下の内容で/etc/apt/sources.list.d/groonga.listというを作成し、ソースを登録します。</p>
<div class="emlist-code">
<p class="caption">/etc/apt/sources.list.d/groonga.list</p>
<pre class="emlist">deb http://packages.groonga.org/debian/ jessie main
deb-src http://packages.groonga.org/debian/ jessie main
</pre>
</div>
<p>次にインストールします。</p>
<div class="emlist-code">
<pre class="emlist">% sudo apt-get update
% sudo apt-get install -y --allow-unauthenticated groonga-keyring
% sudo apt-get update
% sudo apt-get install -y -V mysql-server-mroonga
</pre>
</div>
<p>以上でインストールは終了です。</p>
<p>実際にインストールする際には細部が変わっている可能性もあるため、一度以下の公式ドキュメントを確認しましょう。</p>
<p><a href="http://mroonga.org/ja/docs/install/debian.html" class="link">http://mroonga.org/ja/docs/install/debian.html</a></p>

<h3><a id="hA-1-2"></a>Windows、OS X、Ubuntu、CentOS</h3>
<p>Windows用にも公式にMroongaのインストーラー及びコンパイル済みパッケージのZIPアーカイブが提供されています。OS XのHomebrew、UbuntuのAPT、CentOSのYum用にはリポジトリーが提供されています。</p>
<p>いずれも公式サイトにインストール方法がありますので、参照してください。</p>
<p><a href="http://mroonga.org/ja/docs/install.html" class="link">http://mroonga.org/ja/docs/install.html</a></p>

<h3><a id="hA-1-3"></a>Docker</h3>
<p>MroongaのDockerイメージもDocker Hubから配布されています。以下のように<code class="inline-code tt">docker run</code>コマンドを実行することで、自動的にイメージの取得からコンテナの起動までが行われます。</p>
<div class="emlist-code">
<p class="caption">MroongaのDockerイメージの取得</p>
<pre class="emlist">% docker run --detach --publish=3306:3306 groonga/mroonta
</pre>
</div>
<p>これでポート番号3306をリスンしながらMroongaインストール済みのMySQLサーバーが起動します。通常のMySQLクライアントを使って接続が可能です。</p>
<div class="emlist-code">
<p class="caption">Mroongaへの接続</p>
<pre class="emlist">% mysql --host=127.0.0.1 --port=3306 --user=root
</pre>
</div>
<p>（Linux以外は--hostが違いそう）</p>
<p>但し、Dockerコンテナは、削除と同時にデータが失われてしまいます。これは多くの場合望ましい挙動ではないでしょう。次のように<code class="inline-code tt">volume</code>オプションを追加することで、ホスト上のディレクトリーをコンテナと共有できます。</p>
<div class="emlist-code">
<p class="caption">volumeオプションの指定</p>
<pre class="emlist">% docker run --detach --publish=3306:3306 --volume=/tmp/mroonga:/var/lib/mysql groonga/mroonga
</pre>
</div>
<p>これで、 ホスト側の/tmp/mroonga以下にMySQLのデータファイルが作成されるようになります。</p>
<p>Mroongaを使ったテーブルの作成については、「A.2 データベースとテーブルの作成」を参照してください。</p>
<p>また、MroongaのDockerイメージは、MySQLとMroongaそれぞれのバージョンの組み合わせごとに多数のイメージが作られています。入手可能な組み合わせはDocker HubのMroongaのページで確認できます。</p>
<p><a href="https://hub.docker.com/r/groonga/mroonga/" class="link">https://hub.docker.com/r/groonga/mroonga/</a></p>

<h2><a id="hA-2"></a><span class="secno">A.2　</span>データベースとテーブルの作成</h2>
<p>データベースの作成には、通常のMySQLと変わることは何もありません。MySQLサーバーに接続し、<code class="inline-code tt">CREATE DATABASE</code>文を実行することでデータベースを作成します。</p>
<div class="emlist-code">
<p class="caption">データベースの作成</p>
<pre class="emlist language-SQL">CREATE DATABASE pdfsearch;
</pre>
</div>
<p>必要に応じて権限設定などを行ってください。</p>
<p>テーブルの作成には気を付けることがあります。まず、ストレージエンジンをMroongaにする必要があります。MySQLで何も指定せずに<code class="inline-code tt">CREATE TABLE</code>を実行した場合、ストレージエンジンはデフォルトのInnoDBになります。これを他のストレージエンジンに変更するには、<code class="inline-code tt">ENGINE</code>オプションを使用します。</p>
<div class="emlist-code">
<p class="caption">テーブルのストレージエンジンにMroongaを指定</p>
<pre class="emlist language-SQL">CREATE TABLE `pdfs` (
-- カラム定義等
) ENGINE = Mroonga DEFAULT CHARSET utf8;
</pre>
</div>
<p>また、検索対象にしたいカラムに、（通常のインデックスとは異なる）全文検索用インデックスを作成する必要があります。</p>
<div class="emlist-code">
<p class="caption">全文検索インデックスの追加</p>
<pre class="emlist language-SQL">ALTER TABLE `pdfs` ADD FULLTEXT INDEX (title, content);
</pre>
</div>
<p>これ自体は通常のMySQLでの操作なので、<code class="inline-code tt">ALTER TABLE</code>のほか、<code class="inline-code tt">CREATE TABLE</code>でインデックスを作成することもできます。</p>
<div class="emlist-code">
<p class="caption">テーブル作成時の全文検索インデックスの作成</p>
<pre class="emlist language-SQL">CREATE TABLE `pdfs` (
    id      INT PRIMARY KEY AUTO_INCREMENT,
    file    VARCHAR(255),
    title   VARCHAR(255),
    content LONGTEXT,
    FULLTEXT INDEX (title, content)
) ENGINE = Mroonga DEFAULT CHARSET utf8;
</pre>
</div>
<p>これは、本書で使用したDockerイメージを作る際に、実際に使用したSQL文です。</p>
<p>また、SQLを使わず<a href="https://www.phpmyadmin.net/" class="link">phpMyAdmin</a>のUIでテーブルを作成することもあるかも知れません。Mroongaがインストール済みであれば、phpMyAdminでもストレージエンジンの選択肢にMroongaが追加されていることを確認しているので、同じようにMroongaを使い始めることができます。</p>

<h2><a id="hA-3"></a><span class="secno">A.3　</span>Mroongaのコミュニティ、サポート</h2>
<p>Mroongaを含むGroongaについては、開発者が日本人であることもあり、日本語で気軽に問い合わせられます。公式サイトにはメーリングリスト、チャット、Twitter、Facebookページについて紹介されているので、質問や要望がある際にはぜひ活用してください。</p>
<p><a href="http://mroonga.org/ja/docs/community.html" class="link">http://mroonga.org/ja/docs/community.html</a></p>
<p>また、開発や運用などの有償のサポートサービスもあります。業務で使用する場合には検討するといいでしょう。</p>
<p><a href="http://groonga.org/ja/support/" class="link">http://groonga.org/ja/support/</a></p>

<h2><a id="hA-4"></a><span class="secno">A.4　</span>Dockerコンテナの作り直し</h2>
<p>本書のサンプルではDockerコンテナを使ってApache、PHP、MySQLを動かしています。時には始めからやり直したくなることもあるかも知れません。そうした場合は、以下のように一度コンテナを削除して作り直すことができます。</p>
<div class="emlist-code">
<p class="caption">コンテナの削除</p>
<pre class="emlist">% docker rm pdfsearch
</pre>
</div>
<div class="emlist-code">
<p class="caption">コンテナの作成</p>
<pre class="emlist">% docker run --detach --name=pdfsearch --publish=8080:80 \
    --volume=$PWD:/var/lib/pdfsearch kitaitimakoto/grnbook-mroonga
</pre>
</div>
<p>コンテナを削除すると、データベース内のデータは全て失われます。PDFの登録からやり直しとなるので注意しましょう。ホストと共有しているPHPファイルは消えることはありません。</p>

<h2><a id="hA-5"></a><span class="secno">A.5　</span>phpMyAdminによるデータの確認・操作</h2>
<p>本書のDockerイメージにはphpMyAdminもインストールされており、<code class="inline-code tt">http://localhost:8080/phpmyadmin</code>でアクセスできます。名前が<code class="inline-code tt">root</code>、パスワードはなし、というユーザーが登録されており、全権限を所有しています（PHPで使用しているユーザーと同じです）。</p>
<p>これを使って実際に入っているデータを確認・削除したり、コンテナはそのままでデータベースやテーブルの再作成を行ったりできます。テーブル作成時はストレージエンジンにMroongaを指定することを忘れないようにしてください。詳細は「A.2 データベースとテーブルの作成」で解説しています。</p>

<h2><a id="hA-6"></a><span class="secno">A.6　</span>PHPのデバッグ</h2>
<p>本書サンプルで作成するDockerコンテナの中ではApacheのmod_phpモジュールを使ってPHP 5.6が動作しています。もし、PHPスクリプトがうまく動作しない場合は、Apacheのエラーログを確認するといいでしょう。</p>
<p>まず、<code class="inline-code tt">docker exec</code>コマンドを使ってコンテナの中に入ります（正確にはコンテナの中でbashを実行します）。</p>
<div class="emlist-code">
<p class="caption">docker execでコンテナの中に入る</p>
<pre class="emlist">% docker exec --interactive --tty pdfsearch /bin/bash
</pre>
</div>
<p>Apacheのエラーログは/var/log/apache2/error_logなので、これを<code class="inline-code tt">less</code>や<code class="inline-code tt">tail</code>などのコマンドで見ながらPHPを実行することで、どんなエラーが起きているのかを知ることができます。</p>
<div class="emlist-code">
<p class="caption">ログファイルを監視する</p>
<pre class="emlist"># less /var/log/apache2/error_log
# tail -f /var/log/apache2/error_log
</pre>
</div>
      </div>
      <nav class="book-navi book-prev">
                <a href="ch06.html">
          <div class="book-cursor"><span class="cursor-prev">◀</span></div>
        </a>
              </nav>
      <nav class="book-navi book-next">
              </nav>
    </div>
  </div>
  <footer>
      </footer>
  </body>
</html>
