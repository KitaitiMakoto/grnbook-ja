<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="main.css" />
<link rel="next" title="作成する全文検索システムの概要" href="ch03.html"><link rel="prev" title="Mroongaの概要" href="ch01.html">  <meta name="generator" content="Re:VIEW" />
  <title>Mroongaの環境の準備 | Groongaではじめる全文検索</title>
</head>
<body>
  <div class="book">
    <nav class="side-content">
      <h1>Groongaではじめる全文検索</h1>
      <ul class="book-toc">
<li><a href="index.html">TOP</a></li>
<li><a href="./intro.html">MySQLで作る全文検索システム</a></li>
<li><a href="./ch01.html">1 Mroongaの概要</a></li>
<li><a href="./ch02.html">2 Mroongaの環境の準備</a></li>
<li><a href="./ch03.html">3 作成する全文検索システムの概要</a></li>
<li><a href="./ch04.html">4 データ入力機能の作成</a></li>
<li><a href="./ch05.html">5 全文検索機能の作成</a></li>
<li><a href="./ch06.html">6 Mroongaならではの機能の作成</a></li>
<li><a href="./appendix.html">付録</a></li>
</ul>
      <p class="review-signature">powered by <a href="http://reviewml.org/">Re:VIEW</a></p>
    </nav>
    <div class="book-body">
      <header>
      </header>
      <div class="book-page">
        <h1><a id="h2"></a><span class="secno">第2章　</span>Mroongaの環境の準備</h1>
<p>本書では、MySQL及びその他の環境の準備にDockerを使います。OS X El Capitanで確認していますが、異なるOSでも違いはないと思います。</p>
<p>以後、PHPとMySQL、Mroongaを使ってPDF文書の全文検索システムを作成していきますが、ラップトップなどの普段使っているシステムにインストール済みの物を使うと、バージョンが異なって本書の内容が当てはまらなかったり、また、将来別件で異なるバージョンをインストールしたい場合などに手間が増えてしまいます。設定ファイルの競合も問題になるかも知れません。Dockerを使うと、システムの方に影響を与えずに、本書で必要なバージョンのソフトウェアを揃えることができます。不要になった場合には削除することも簡単で、その場合もシステムの方には影響を及ぼしません。</p>

<h2><a id="h2-1"></a><span class="secno">2.1　</span>Dockerのインストール</h2>
<p>まず、Dockerその物をインストールしましょう。DockerはOS X、Windows、Linuxそれぞれのプラットフォームで動作します。本番環境として動かすにはLinuxを使うべきですが、本書のようなお試し環境の共有目的ではどの環境で使っても問題ありません。ここでは、本書執筆の際にも使用した、OS Xでのインストール方法を解説します。Linux、Windowsでのインストールについては、それぞれDocker公式サイトでの解説を参照してください。</p>
<ul>
<li>Linuxの場合 ... <a href="https://docs.docker.com/engine/installation/linux/" class="link">Install Docker on Linux distributions</a></li>
<li>Windowsの場合 ... <a href="https://docs.docker.com/docker-for-windows/" class="link">Get started with Docker for Windows</a></li>
</ul>

<h3><a id="h2-1-1"></a>OS Xへのインストール</h3>
<p>Docker公式サイトでは<a href="https://docs.docker.com/docker-for-mac/" class="link">Get started with Docker for Mac</a>でインストール方法が解説されていますので、以下の方法でうまくいかない場合などには参照してください。</p>
<p>OS XへDockerをインストールするには、公式サイトで配布されているDocker for Macをインストールします。これはDocker関連ツールをまとめたパッケージです。以下の配布ページから「Get Docker for Mac (stable)」と書かれたリンクからダウンロードし、インストーラーでインストールしてください。尚、Docker ToolboxのインストールにはOS X 10.11以上が必要です（2017年1月現在）。</p>
<p><a href="https://docs.docker.com/docker-for-mac/#/download-docker-for-mac" class="link">https://docs.docker.com/docker-for-mac/#/download-docker-for-mac</a></p>
<p>インストールが終わったら、Dockerを起動します。アプリケーションディレクトリーでDockerをダブルタップするか、SpotlightでDockerを検索して実行してください<a id="fnb-docker-privileges" href="#fn-docker-privileges" class="noteref" epub:type="noteref">*1</a>。するとメニューバーにDockerのクジラのアイコンが表示されます。これによりDockerの起動が確認できました。</p>
<div class="footnote" epub:type="footnote" id="fn-docker-privileges"><p class="footnote">[*1] 初回実行時には「Docker needs privileged access.」というウィンドウに続き、OSのパスワード入力が求められます。これはDockerが管理者権限を要する操作を行うためです。</p></div>

<h2><a id="h2-2"></a><span class="secno">2.2　</span>Dockerコンテナの起動</h2>
<p>Dockerを使用するには、必要なソフトウェアをインストールし、起動時の動作を定義した「イメージ」が必要です。イメージを取得した後に、そのイメージを雛形としてアプリケーションの動作環境となるコンテナを作ります。一つのイメージからは複数のコンテナを作成して使用することができます。</p>
<p>本書用に必要なソフトウェアをインストールしたDockerイメージを作成してあります。これを元に皆さんのコンテナを作成し、その中でPHPを実行して全文検索システムを作っていきます。</p>
<p>まずはイメージを取得します。ターミナルで以下のコマンドを実行してください。</p>
<div id="id_docker-pull" class="caption-code">
<p class="caption">リスト2.1: Dockerイメージの取得</p>
<pre class="list highlight">% docker pull kitaitimakoto/grnbook-mroonga
Using default tag: latest
latest: Pulling from kitaitimakoto/grnbook-mroonga
fdd5d7827f33: Pull complete
a3ed95caeb02: Pull complete
0f35d0fe50cc: Pull complete
627b6479c8f7: Pull complete
67c44324f4e3: Pull complete
1429c50af3b7: Pull complete
8207a1b09d34: Pull complete
f4fd1f72cd2a: Pull complete
8c4074b3c552: Pull complete
d0e29d6de6ea: Pull complete
07672a754971: Pull complete
b0c92bbfd7a4: Pull complete
a42300873aad: Pull complete
2682e716a4cc: Pull complete
dd4fb0863e03: Pull complete
1cf726591e93: Pull complete
9435561d81cb: Pull complete
21da239ddc32: Pull complete
a563b423501c: Pull complete
Digest: sha256:b0c1a8cdde715ff679054eb8d22bf984fad29c285404d8365e135adf73d0bbd3
Status: Downloaded newer image for kitaitimakoto/grnbook-mroonga:latest
</pre>
</div>
<p>これにより、Docker HubというDockerイメージ登録サービスから、本書用のイメージをダウンロードします。1GiB以上あるので時間が掛かります。場合によってはネットワークを共有している同僚などに迷惑を掛けるかも知れませんので、周りの状況をよく見て実施しましょう。</p>
<p>次に、このイメージを元に、あなたのアプリケーションを作成し実施するための仮想環境「コンテナ」を作成します。本書サンプル用の適当なディレクトリーに移動し、以下のコマンドを実行します。</p>
<div id="id_docker-create" class="caption-code">
<p class="caption">リスト2.2: Dockerコンテナの作成</p>
<pre class="list highlight">% cd path/to/project
% docker create \
    --name=pdfsearch \
    --publish=8080:80 \
    --volume=$PWD:/var/lib/pdfsearch \
    kitaitimakoto/grnbook-mroonga
69277eea1becda07e4d6314485b6bd48fcfee065b23fa3692ad015d43d5f5c6f
</pre>
</div>
<p>コマンドを実行した結果表示される「<code class="tt">69277eea1becda07e4d6314485b6bd48fcfee065b23fa3692ad015d43d5f5c6f</code>」という行は、このコンテナのIDです。システム全体の中でそれぞれのコンテナを一意に特定するための物で、同じイメージから作成しても、別のコンテナには別のIDが割り振られます。今後、コンテナを操作する時にはこのIDを使用することができます。しかし、これを覚えるのは不可能ですし、一々確認のためのコマンドを実行するのも手間ですので、<code class="inline-code tt">name</code>オプションにより名前を付けました。以後はIDの代わりに、この名前（<code class="inline-code tt">pdfsearch</code>）を使用していきます。なお、この名前もシステム内で一意である必要があり、後から同じ名前のコンテナを作ろうとしても失敗します。</p>
<p><code class="inline-code tt">publish</code>オプションではポート番号のマッピングを定義しています。コロンの左側にホスト側（Dockerを実行している皆さんのコンピューター）のポート番号を書き、右側にコンテナ内のポート番号を書きます。コンテナ内ではApache HTTP Serverが80番ポートをリッスンしますので、この場合はホスト側の8080番ポートにアクセスするとコンテナ内のApacheに接続できるようになっています。ホスト側のポート番号は他で使用している可能性もありますが、その場合には、次のように<code class="inline-code tt">publish</code>オプションで変更してください。</p>
<div id="id_change-port" class="caption-code">
<p class="caption">リスト2.3: 8000番ポートを公開する例</p>
<pre class="list highlight">% docker create \
    --name=pdfsearch \
    --publish=8000:80 \
    --volume=$PWD:/var/lib/pdfsearch \
    kitaitimakoto/grnbook-mroonga
</pre>
</div>
<p>また<code class="inline-code tt">volume</code>オプションによって、ホスト側とコンテナ内との共有ディレクトリーを指定しています。ここでもコロンの左側（<code class="inline-code tt">$PWD</code>）がホスト側のディレクトリー、右側（<code class="inline-code tt">/var/lib/pdfsearch</code>）がコンテナ内のディレクトリーです。ここで指定したディレクトリー以外は、原則としてホスト側とは共有されません<a id="fnb-share-volume" href="#fn-share-volume" class="noteref" epub:type="noteref">*2</a>。右側は、このディレクトリーがApacheのドキュメントルートとなるよう設定しているので、変更しないでください。</p>
<p>最後に、このコンテナを起動しましょう。<code class="inline-code tt">docker start</code>コマンドを使用します。</p>
<div id="id_docker-start" class="caption-code">
<p class="caption">リスト2.4: Dockerコンテナの起動</p>
<pre class="list highlight">% docker start pdfsearch
pdfsearch
</pre>
</div>
<p>実はここまでの<code class="inline-code tt">docker pull</code>、<code class="inline-code tt">create</code>、<code class="inline-code tt">start</code>をまとめて行う、<code class="inline-code tt">docker run</code>というコマンドがあります。</p>
<div id="id_docker-run" class="caption-code">
<p class="caption">リスト2.5: Dockerイメージの取得とコンテナの起動</p>
<pre class="list highlight">% docker run \
    --detach \
    --name=pdfsearch \
    --publish=8080:80 \
    --volume=$PWD:/var/lib/pdfsearch \
    kitaitimakoto/grnbook-mroonga
</pre>
</div>
<p>このように<code class="inline-code tt">docker run</code>コマンドを実行することで、以下の三つのことが行われます。</p>
<ol>
<li>Dockerイメージの取得（もしシステム上に存在しない場合）（<code class="inline-code tt">docker pull</code>）</li>
<li>取得したDockerイメージを元にしたDockerコンテナの作成（<code class="inline-code tt">docker create</code>）</li>
<li>作成したDockerコンテナの起動（<code class="inline-code tt">docker start</code>）</li>
</ol>
<p>先に説明した通り、<code class="inline-code tt">name</code>オプションを指定している場合は、複数回実行すると名前の重複によりコンテナの作成に失敗します。もし指定しなかった場合は、実行の度に新しいコンテナが作成・起動されます。コンテナを起動する二度目以降は<code class="inline-code tt">docker start</code>を使ってください。</p>
<p>行っていることの説明のため三つのステップで説明しましたが、実際には<code class="inline-code tt">docker run</code>コマンドを実行するのが簡単でしょう。</p>
<p>起動したコンテナを停止するには<code class="inline-code tt">docker stop</code>コマンドを実行します。</p>
<div id="id_docker-stop" class="caption-code">
<p class="caption">リスト2.6: Dockerコンテナの停止</p>
<pre class="list highlight">% docker stop pdfsearch
pdfsearch
</pre>
</div>

<h2><a id="h2-3"></a><span class="secno">2.3　</span>動作確認</h2>
<p>Dockerコンテナが実際に動作していることを確認しましょう。Dockerコンテナを停止している場合には、<code class="inline-code tt">docker start pdfsearch</code>で再度起動してください。</p>
<p>このイメージにはPHPが含まれているので、<code class="inline-code tt">docker run</code>または<code class="inline-code tt">create</code>を実行したディレクトリーで以下のようなファイルを作成することで動作確認ができます。</p>
<div id="info.php" class="caption-code">
<p class="caption">リスト2.7: info.php</p>
<pre class="list language-php highlight">&lt;?php
phpinfo();

</pre>
</div>
<p>ブラウザーで <code class="tt">http://localhost:8080/info.php</code> にアクセスしてみましょう。</p>
<div id="phpinfo" class="image">
<img src="images/ch02/phpinfo.png" alt="phpinfo()の実行結果" />
<p class="caption">
図2.1: phpinfo()の実行結果
</p>
</div>
<p>PHPの情報が表示されれば、環境の準備は成功しています。</p>
<p>「Not Found」の画面が表示されてしまう場合は、どこかで間違えてしまったようです。これまでの手順を見ながらやり直してみてください。</p>
<p><code class="inline-code tt">docker run</code>をやり直すには、以下のコマンドを実行して一旦Dockerコンテナを停止し、削除する必要があります。</p>
<div class="emlist-code">
<p class="caption">Dockerコンテナの停止と削除</p>
<pre class="emlist highlight">% docker stop pdfsearch
pdfsearch
% docker rm pdfsearch
pdfsearch
</pre>
</div>
<p>ありがちな間違いとして、Dockerコンテナとの共有ディレクトリーの指定ミスがあります。<code class="inline-code tt">docker run</code>（<code class="inline-code tt">docker create</code>）コマンドの<code class="inline-code tt">volume</code>オプションをもう一度確認しましょう。<code class="inline-code tt">$PWD</code>は（<code class="inline-code tt">docker run</code>を実行した）現在のディレクトリーを意味しますので、そこと別のディレクトリーにファイルを置いた場合は、コンテナ内のPHPが認識できません。事前にプロジェクトのディレクトリーに移動してから実行するようにしましょう。</p>
<div class="footnote" epub:type="footnote" id="fn-share-volume"><p class="footnote">[*2] 原則を外れることもできますが、本書の範囲外のため解説しません。気になる方はDockerの公式サイトなどで<code class="inline-code tt">volume</code>オプション及び「Dockerfileの<code class="inline-code tt">VOLUME</code>命令」を調べてみてください。</p></div>
      </div>
      <nav class="book-navi book-prev">
                <a href="ch01.html">
          <div class="book-cursor"><span class="cursor-prev">◀</span></div>
        </a>
              </nav>
      <nav class="book-navi book-next">
                <a href="ch03.html">
          <div class="book-cursor"><span class="cursor-next">▶</span></div>
        </a>
              </nav>
    </div>
  </div>
  <footer>
      </footer>
  </body>
</html>
