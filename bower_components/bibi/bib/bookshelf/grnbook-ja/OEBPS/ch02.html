<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="main.css" />
  <meta name="generator" content="Re:VIEW" />
  <title>Mroongaの環境の準備</title>
</head>
<body>
<h1><a id="h2"></a><span class="secno">第2章　</span>Mroongaの環境の準備</h1>
<p>本書では、MySQL及びその他の環境の準備にDockerを使います。</p>
<p>以後、PHPとMySQL、Mroongaを使ってPDF文書の全文検索システムを作成していきますが、普段使っているシステムにインストール済みの物を使うと、バージョンが異なって本書の内容が当てはまらなかったり、また、将来別件で異なるバージョンをインストールしたい場合などに手間が増えてしまいます。設定ファイルの競合も問題になるかも知れません。Dockerを使うと、システムの方に影響を与えずに、本書で必要なバージョンのソフトウェアを揃えることができます。不要になった場合には削除することも簡単で、その場合もシステムの方には影響を及ぼしません。</p>

<h2><a id="h2-1"></a><span class="secno">2.1　</span>Dockerのインストール</h2>
<p>（後で書く）</p>

<h2><a id="h2-2"></a><span class="secno">2.2　</span>Dockerコンテナの起動</h2>
<p>本書用に必要なソフトウェアをインストールしたDockerイメージを作成してあります。ターミナルで上の<code class="inline-code tt">docker run</code>を実行したディレクトリーに移動し、以下のコマンドを実行してください。</p>
<div class="caption-code">
<p class="caption">リスト2.1: Dockerイメージの取得とコンテナの起動</p>
<pre class="list">% cd path/to/project
% docker run --detach --name=pdfsearch --publish=8080:80 \
    --volume=$PWD:/var/lib/pdfsearch kitaitimakoto/grnbook-mroonga
</pre>
</div>
<p><code class="inline-code tt">docker run</code>コマンドにより、以下の三つのことが行われます。</p>
<ol>
<li>インターネット経由のDockerイメージの取得（もしシステム上に存在しない場合）</li>
<li>取得したDockerイメージを元にしたDockerコンテナの作成</li>
<li>作成したDockerコンテナの起動</li>
</ol>
<p>Dockerイメージの取得とコンテナの作成は一度行えば充分なので、コンテナの二度目以降の起動には別のコマンドを使用します。</p>
<div class="emlist-code">
<p class="caption">Dockerコンテナの起動</p>
<pre class="emlist">% docker start pdfsearch
</pre>
</div>
<div class="emlist-code">
<p class="caption">Dockerコンテナの停止</p>
<pre class="emlist">% docker stop pdfsearch
</pre>
</div>
<p>コンテナの操作に使用している<code class="inline-code tt">pdfsearch</code>という名前は、リスト2.1における<code class="inline-code tt">name</code>オプションで指定した物を使用しています。<code class="inline-code tt">docker run</code>実行時に異なる名前を指定した場合は、そちらを使いましょう。（nameをつけ忘れた時はdocker psで探して消すが、説明いる？）</p>
<p>もし、二度目も<code class="inline-code tt">docker run</code>コマンドを使用してしまうと、新たに<em>別の</em>コンテナを作成してしまいます。MySQLのデータ等は引き継がれませんし、同じ目的のコンテナが二つ以上あると混乱の元ですので、通常は一つになるようにしておきましょう。</p>

<h2><a id="h2-3"></a><span class="secno">2.3　</span>動作確認</h2>
<p>Dockerコンテナが実際に動作していることを確認しましょう。このイメージにはPHPが含まれているので、<code class="inline-code tt">docker run</code>を実行したディレクトリーで以下のようなファイルを作成することで動作確認ができます。</p>
<div class="caption-code">
<p class="caption">リスト2.2: info.php</p>
<pre class="list"><span style="color: #BC7A00">&lt;?php</span>
<span style="color: #008000">phpinfo</span>();
</pre>
</div>
<p>ブラウザーでhttp://localhost:8080/info.phpにアクセスしてください。PHPの情報が表示されれば、環境の準備は成功しています。（Docker Toolbox使っている場合はlocalhostじゃなさそう）</p>
<p>「Not Found」の画面が表示されてしまう場合は、どこかで間違えてしまったようです。これまでの手順を見ながらやり直してみてください。</p>
<p><code class="inline-code tt">docker run</code>をやり直すには、以下のコマンドを実行して一旦Dockerコンテナを停止し、削除する必要があります。</p>
<div class="emlist-code">
<p class="caption">Dockerコンテナの停止と削除</p>
<pre class="emlist">% docker stop pdfsearch
% docker rm pdfsearch
</pre>
</div>
<p>ありがちな間違いとして、Dockerコンテナとの共有ディレクトリーの指定ミスがあります。Dockerコンテナとホストマシンは、<code class="inline-code tt">docker run</code>コマンドの<code class="inline-code tt">volume</code>（<code class="inline-code tt">v</code>）オプションで指定したディレクトリーを共有します。上の例では<code class="inline-code tt">$PWD:/var/lib/pdfsearch</code>を指定しています。コロンの左側がホストマシンのディレクトリー、右側がコンテナ内のディレクトリーです。<code class="inline-code tt">$PWD</code>は（<code class="inline-code tt">docker run</code>を実行した）現在のディレクトリーを意味しますので、そこと別のディレクトリーにファイルを置いた場合は、コンテナ内のPHPが認識できません。事前にプロジェクトのディレクトリーに移動してから実行するようにしましょう（コンテナ内は<code class="inline-code tt">/var/lib/pdfsearch</code>がドキュメントルートとなるよう設定されており、こちらは常にこの値で大丈夫です）。</p>
</body>
</html>
