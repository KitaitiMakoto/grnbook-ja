<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="main.css" />
  <meta name="generator" content="Re:VIEW" />
  <title>Mroongaならではの機能の作成</title>
</head>
<body>
<h1><a id="h6"></a><span class="secno">第6章　</span>Mroongaならではの機能の作成</h1>
<p>ここからは、MySQLの全文検索機能にはない、Mroongaならではの特徴を活かした機能を実装していきます。</p>

<h2><a id="h6-1"></a><span class="secno">6.1　</span>検索語のハイライト</h2>
<p>現在の検索機能では、検索結果中、どこに検索語があるのか、自分で探さなくてはなりません。次の画像のように、検索語だけがハイライトされていると、とても見やすくなります。また、菌類についてのPDFを探すつもりで「きのこ」で検索し「お気づきのこと」といった関係ない語がヒットした場合に、すぐにそのことに気付けるというメリットもあります。</p>
<div id="highlight" class="image">
<img src="images/ch06/highlight.png" alt="検索語をハイライトして表示" />
<p class="caption">
図6.1: 検索語をハイライトして表示
</p>
</div>
<p>このように検索語をハイライトする機能を実装してみましょう。</p>
<p>すぐに思い付く実装方法は、取得した検索結果の<code class="inline-code tt">content</code>カラムを、再度PHPで解析してタグを挿入することですが、実はMroongaには、このための機能が備わっています。SQL中で利用可能な<code class="inline-code tt">mroonga_snippet_html()</code>関数です。これは特定のカラム（ここでは<code class="inline-code tt">content</code>）のうち、指定した語（「cat」）の前後数十バイトを抜き出し、文字列として返す関数です。</p>
<p><code class="inline-code tt">mroonga_snippet_html()</code>関数が返すスニペットは<code class="inline-code tt">&lt;div class=&quot;snippet&quot;&gt;</code>...<code class="inline-code tt">&lt;/div&gt;</code>というタグで囲まれ、更に検索語は<code class="inline-code tt">&lt;span class=&quot;keyword&quot;&gt;</code>...<code class="inline-code tt">&lt;/span&gt;</code>で囲まれます<a id="fnb-mroonga_snippet" href="#fn-mroonga_snippet" class="noteref" epub:type="noteref">*1</a>。一レコード中に検索語が複数回現れる場合は、その数に応じて複数のスニペットを結合した一つの文字列を返します。余談ですが「スニペット」は「断片」という意味で、この場合は<code class="inline-code tt">content</code>カラムのうちの一部を返すことを意味しています。</p>
<p><code class="inline-code tt">mroonga_snippet_html()</code>は以下のようにして使用します。</p>
<div class="emlist-code">
<p class="caption">mroonga_snippet_htmlの簡単な使い方</p>
<pre class="emlist language-SQL">SELECT mroonga_snippet_html(content, 'きのこ') FROM `pdfs`;
</pre>
</div>
<p>結果は、例えば次のようになります<a id="fnb-linebreak" href="#fn-linebreak" class="noteref" epub:type="noteref">*2</a>。</p>
<div class="emlist-code">
<p class="caption">mroonga_snippet_html()の結果例</p>
<pre class="emlist language-HTML">&lt;div class=&quot;snippet&quot;&gt;ットとするつもりだったのに間違えて git add * と打ち込んでし
まったと&lt;span class=&quot;keyword&quot;&gt;きのこ&lt;/span&gt;とを考えましょう。 ファイルが両方ともステージされて
しまいました&lt;/div&gt;&lt;div class=&quot;snippet&quot;&gt;細は、“何が変わるのかの把握” を参照ください
もうひとつお気づ&lt;span class=&quot;keyword&quot;&gt;きのこ&lt;/span&gt;とがあることでしょう。 GitHub は、このプル
リクエストが問題なくマー&lt;/div&gt;
</pre>
</div>
<p>ここでは、本書のアプリケーションに必要なことのみ説明しているので、詳細については公式ドキュメント（<a href="http://mroonga.org/ja/docs/reference/udf/mroonga_snippet_html.html" class="link">5.5.5. mroonga_snippet_html()</a>）を参照してください。</p>
<p>現在の実装では検索でヒットした時に<code class="inline-code tt">content</code>カラムの抜粋を表示していますが、<code class="inline-code tt">mroonga_snippet_html()</code>の戻り値で置き換えてみましょう。<code class="inline-code tt">PDFSearch\Table::search()</code>で使用しているSQL（<code class="inline-code tt">PDFSearch\Table::SEARCH</code>定数）を変更します。<code class="inline-code tt">mroonga_snippet_html()</code>も<code class="inline-code tt">COUNT()</code>などと同様の関数なので、<code class="inline-code tt">AS</code>句を使って別名を付けることができます。</p>
<div class="caption-code">
<p class="caption">リスト6.1: table.php</p>
<pre class="list language-php">&lt;?php
namespace PDFSearch;

class Table
{
    const INSERT =
        &quot;INSERT INTO `pdfs` (file, title, content)
         VALUES(:file, :title, :content);&quot;;
    const SELECT = &quot;SELECT * FROM `pdfs` ORDER BY `id`;&quot;;
    const SEARCH = &lt;&lt;&lt;EOS
SELECT file, title, mroonga_snippet_html(content, :query AS query) AS snippets
FROM `pdfs` WHERE MATCH(title, content) AGAINST(:query IN BOOLEAN MODE);
EOS;

    protected $pdo;

    public function __construct($dsn, $username, $password)
    {
        $this-&gt;pdo = new \PDO($dsn, $username, $password);
    }

    public function insert(Upload $upload)
    {
        $params = [
            ':file'    =&gt; $upload-&gt;getName(),
            ':title'   =&gt; $upload-&gt;getTitle(),
            ':content' =&gt; $upload-&gt;getContent()
        ];
        $sth = $this-&gt;pdo-&gt;prepare(self::INSERT);
        $isSucceeded = $sth-&gt;execute($params);
        if (! $isSucceeded) {
            throw new \RuntimeException(implode(PHP_EOL, $sth-&gt;errorInfo()));
        }
    }

    public function records()
    {
        $sth = $this-&gt;pdo-&gt;prepare(self::SELECT);
        $isSucceeded = $sth-&gt;execute();
        if (! $isSucceeded) {
            throw new \RuntimeException(implode(PHP_EOL, $sth-&gt;errorInfo()));
        }
        return $sth-&gt;fetchAll();
    }

    public function search($query)
    {
        $sth = $this-&gt;pdo-&gt;prepare(self::SEARCH);
        $params = [':query' =&gt; $query];
        $isSucceeded = $sth-&gt;execute($params);
        if (! $isSucceeded) {
            throw new \RuntimeException(implode(PHP_EOL, $sth-&gt;errorInfo()));
        }
        return $sth-&gt;fetchAll();
    }
}
</pre>
</div>
<p>HTML中で<code class="inline-code tt">content</code>カラムを表示していた所を、<code class="inline-code tt">snippets</code>に置き換えます。</p>
<div class="caption-code">
<p class="caption">リスト6.2: index.php</p>
<pre class="list language-php">&lt;?php
// Dockerイメージ内にComposerでインストール済みのライブラリーを読み込む
require_once 'vendor/autoload.php';
require_once __DIR__ . '/upload.php';
require_once __DIR__ . '/table.php';

define('DBNAME', 'pdfsearch');

$dsn = 'mysql:host=localhost;dbname=' . DBNAME . ';charset=utf8';
$table = new \PDFSearch\Table($dsn, 'root', '');

function h($string, $flags = ENT_QUOTES, $encoding = 'UTF-8')
{
    return htmlspecialchars($string, $flags, $encoding);
}

// 検索処理
$searchQuery = null;
if ($_SERVER['REQUEST_METHOD'] === 'GET' &amp;&amp;
    array_key_exists('q', $_GET) &amp;&amp; $_GET['q']) {
    $searchQuery = $_GET['q'];
    $searchResult = $table-&gt;search($searchQuery);
}

// ファイルアップロード処理
if ($_SERVER['REQUEST_METHOD'] === 'POST' &amp;&amp;
    array_key_exists('pdf', $_FILES)) {
    $uploads = \PDFSearch\Upload::fromFilesInfo($_FILES['pdf']);
    try {
        foreach ($uploads as $upload) {
            $table-&gt;insert($upload);
        }
        header('Location: .');
    } catch (\RuntimeException $e) {
        header('HTTP', true, 500);
        header('content-type: text/plain');
        echo $e;
    }
    exit;
}

$records = $table-&gt;records();

?&gt;&lt;!doctype html&gt;
&lt;title&gt;PDF Search&lt;/title&gt;
&lt;style&gt;
  .keyword {
    font-weight: bold;
    color: red;
  }
&lt;/style&gt;
&lt;h1&gt;PDF Search&lt;/h1&gt;

&lt;h2&gt;検索&lt;/h2&gt;
&lt;form method=&quot;get&quot;&gt;
  &lt;input name=&quot;q&quot; type=&quot;search&quot; value=&quot;&lt;?php echo h($searchQuery); ?&gt;&quot;&gt;
  &lt;input type=&quot;submit&quot; value=&quot;検索&quot;&gt;
&lt;/form&gt;

&lt;?php if ($searchResult &amp;&amp; count($searchResult) &gt; 0): ?&gt;
&lt;h2&gt;「&lt;?php echo h($searchQuery); ?&gt;」を含むPDF&lt;/h2&gt;
&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;ファイル名&lt;/th&gt;
    &lt;th&gt;タイトル&lt;/th&gt;
    &lt;th&gt;内容&lt;/th&gt;
  &lt;/tr&gt;
  &lt;?php foreach ($searchResult as $record): ?&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;?php echo h($record['file']); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo h($record['title']); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo $record['snippets']; ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;?php endforeach; ?&gt;
&lt;/table&gt;
&lt;?php endif; ?&gt;

&lt;h2&gt;登録済みPDF一覧&lt;/h2&gt;
&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;ファイル名&lt;/th&gt;
    &lt;th&gt;タイトル&lt;/th&gt;
    &lt;th&gt;内容&lt;/th&gt;
  &lt;/tr&gt;
  &lt;?php foreach ($records as $record): ?&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;?php echo h($record['file']); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo h($record['title']); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo h(mb_substr($record['content'], 0, 120)); ?&gt;&amp;hellip;&amp;hellip;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;?php endforeach; ?&gt;
&lt;/table&gt;

&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;
  &lt;input name=&quot;pdf[]&quot; type=&quot;file&quot; multiple&gt;
  &lt;input type=&quot;submit&quot;&gt;
&lt;/form&gt;
</pre>
</div>
<p><code class="inline-code tt">snippets</code>の表示ではHTMLエスケープをしていないことに気が付いたでしょうか。<code class="inline-code tt">mroonga_snippet_html()</code>にHTMLタグが含まれているため、ここでHTMLエスケープしてしまうと、タグとしての役を果たさなくなってしまいます。そのため、直接出力しています。</p>
<p>ここにはセキュリティ上の懸念があります<a id="fnb-notsecurityissue" href="#fn-notsecurityissue" class="noteref" epub:type="noteref">*3</a>。<code class="inline-code tt">mroonga_snippet_html()</code>の戻り値では、カラム中のHTMLタグなどは全てエスケープされますが、取得したスニペットと他の文字列をPHPで結合すると、セキュリティホールになり得ます。加工せず、可能であれば単独で出力するようにしてください。加工や他の文字列との結合が必要な場合は、慎重に行ってください。</p>
<p>これで、検索結果のハイライトも出来ました。実際に検索して結果を楽しみましょう。</p>
<div class="footnote" epub:type="footnote" id="fn-mroonga_snippet"><p class="footnote">[*1] タグや<code class="inline-code tt">class</code>属性を変更したい場合は、柔軟性の高い<a href="http://mroonga.org/ja/docs/reference/udf/mroonga_snippet.html" class="link">mroonga_snippet()</a>関数を使用してください。</p></div>
<div class="footnote" epub:type="footnote" id="fn-linebreak"><p class="footnote">[*2] 読みやすさのため、改行を調整しています。</p></div>
<div class="footnote" epub:type="footnote" id="fn-notsecurityissue"><p class="footnote">[*3] 実際にはHTMLを正しく出力するために必要な注意点です。仮にセキュリティ上問題とならなくても、HTMLが正しく出力されず、アプリケーションが壊れてしまう可能性があります。</p></div>

<h2><a id="h6-2"></a><span class="secno">6.2　</span>スコアによる並び替え</h2>
<p>これまでは、検索結果の並び順については考慮していませんでした。やはり、検索語に近いPDFが先頭に並んでほしいものです。</p>
<p>この「検索語に近い」または「より望ましい」という状態を、Mroongaではスコアという形で、数値として計算することができます。「検索語がより多く含まれているPDFの方が望ましい」「検索語が本文に含まれているよりもタイトルに含まれている方がより望ましい」といった判断が可能になるのです。</p>
<p>Mroongaが使っているスコアの値は、<code class="inline-code tt">WHERE</code>句に指定している<code class="inline-code tt">MATH()</code>...<code class="inline-code tt">AGAINST()</code>の戻り値として取得できます。<code class="inline-code tt">AS</code>で別名を付けると使いやすいでしょう。</p>
<div class="emlist-code">
<p class="caption">スコアの取得</p>
<pre class="emlist language-SQL">SELECT MATCH(title, content) AGAINST('cat' IN BOOLEAN MODE) as score FROM `pdfs`;
</pre>
</div>
<div class="emlist-code">
<pre class="emlist">+-------+
| score |
+-------+
|   315 |
|    10 |
|     0 |
|     0 |
|     4 |
+-------+
5 rows in set (0.47 sec)
</pre>
</div>
<p>このスコアでソートすることで、より望ましい結果を上の方に表示することができます。</p>
<p>では、このスコアというのは何によって決められているのでしょうか。一つは、結果文書の中に含まれている検索語の数です。検索語が多く含まれている文書ほど検索する人の要求に合っていると見做して、検索上位に表示させられるわけです。</p>
<p>以下の用に<code class="inline-code tt">PDFSearch\Table::SEARCH</code>のSQLにちょっとした変更を加えるだけで、多くの場合、期待される検索結果になるでしょう。</p>
<div class="emlist-code">
<p class="caption">変更前の\PDFSearch\Table::SEARCH定数</p>
<pre class="emlist language-SQL">SELECT file, title, mroonga_snippet_html(content, :query) AS snippets
FROM `pdfs` WHERE MATCH(title, content) AGAINST(:query IN BOOLEAN MODE);
</pre>
</div>
<div class="emlist-code">
<p class="caption">変更前の\PDFSearch\Table::SEARCH定数</p>
<pre class="emlist language-SQL">SELECT file, title, mroonga_snippet_html(content, :query) AS snippets,
MATCH(title, content) AGAINST(:query IN BOOLEAN MODE) AS score
FROM `pdfs` WHERE MATCH(title, content) AGAINST(:query IN BOOLEAN MODE)
ORDER BY score DESC;
</pre>
</div>
<p>もう一つの基準は重みと呼ばれます。重みは、どのカラムをより重視するかという指標です。例えば、次のような二つのPDFが登録されているとします。</p>
<div id="two-groongas" class="table">
<p class="caption">表6.1: Groongaという語を含む二つのPDF</p>
<table>
<tr><th>タイトル</th><th>内容</th></tr>
<tr><td><em>Groonga</em>で作る全文検索システム</td><td><em>Groonga</em>を使って全文検索システムを作ります。</td></tr>
<tr><td>わたしのエッセイ集</td><td>今日、<em>Groonga</em>という言葉を耳にしました。不思議な言葉ですね、<em>Groonga</em>。検索してみると、「<em>Groonga</em>で学ぶ全文検索」という勉強会があるみたいなので、全文検索の何かなのでしょう。ところで、全文検索って何？</td></tr>
</table>
</div>
<p>Groongaのことが知りたくて検索する時に、どちらがヒットしてほしいでしょうか。始めの「Groongaで作る全文検索システム」の方ではないでしょうか。でも、「Groonga」という言葉が多く含まれているのは「わたしのエッセイ集」の方なので、今までの実装だと、こちらが上位に表示されることになってしまいます。前者を上位に持って来るために、「検索語がタイトルに含まれている方が、本文に含まれているよりも100倍くらい重要だ」という指標を導入することにしましょう。Mroongaまたは全文検索の言葉で「<code class="inline-code tt">title</code>カラムの重みを<code class="inline-code tt">content</code>カラムの100倍にする」ということになります。</p>
<div id="weight" class="image">
<img src="images/ch06/weight.png" alt="検索語がタイトル含まれている場合スコアが大きくなる" />
<p class="caption">
図6.2: 検索語がタイトル含まれている場合スコアが大きくなる
</p>
</div>
<p>上の画像にある三つのPDFではどれも本文中に「すべて」という語が含まれますが、タイトルにも含まれる「mrubyのすべて」のスコアが、含まれない「APIデザインケーススタディ」「Dockerエキスパート養成読本」に比べ、非常に大きくなっていることが分かります。実際、タイトルの重視をやめると、「mrubyのすべて」と「APIデザインケーススタディ」の順位は逆転します。</p>
<p>このように重み付けするには、<code class="inline-code tt">W</code>プラグマを使用します。</p>
<div class="emlist-code">
<pre class="emlist language-SQL">MATCH(title,content) AGAINST('*W1:100,2:1 API')
</pre>
</div>
<p><code class="inline-code tt">W</code>が重み付けのためのプラグマ使用を指示し、その後はカラムごとの重み付けをカンマ区切りで指定します。「<code class="inline-code tt">1:100</code>」は「（<code class="inline-code tt">MATCH</code>で指定した）1カラム目の重みを100に」、「<code class="inline-code tt">2:1</code>」は「2カラム目の重みを1に」という命令になります。これにより、「検索語が1つタイトルに含まれていると、本文に100個含まれているのと同等のスコアになる」ということを実現しています（実際には100倍の差が付きさえすればいいので、2と200でも、10と1000でも構いません）。</p>
<p>まとめると、実装は次のようになります。</p>
<div class="caption-code">
<p class="caption">リスト6.3: table.php</p>
<pre class="list language-php">&lt;?php
namespace PDFSearch;

class Table
{
    const INSERT =
        &quot;INSERT INTO `pdfs` (file, title, content)
         VALUES(:file, :title, :content);&quot;;
    const SELECT = &quot;SELECT * FROM `pdfs` ORDER BY `id`;&quot;;
    const SEARCH = &lt;&lt;&lt;EOS
SELECT file, title, mroonga_snippet_html(content, :query AS query) AS snippets,
MATCH(title, content) AGAINST(:query_with_pragma IN BOOLEAN MODE) AS score
FROM `pdfs` WHERE MATCH(title, content) AGAINST(:query_with_pragma IN BOOLEAN MODE)
ORDER BY score DESC;
EOS;
    // :
    // :
    public function search($query)
    {
        $sth = $this-&gt;pdo-&gt;prepare(self::SEARCH);
        $params = [
          ':query' =&gt; $query,
          ':query_with_pragma' =&gt; '*D+W1:100,2:1 ' . $query
        ];
        $isSucceeded = $sth-&gt;execute($params);
        if (! $isSucceeded) {
            throw new \RuntimeException(implode(PHP_EOL, $sth-&gt;errorInfo()));
        }
        return $sth-&gt;fetchAll();
    }
}
</pre>
</div>
<p><code class="inline-code tt">W</code>プラグマを色々な値に変えて試してみてください。本書のようなチュートリアルではなく、実際の全文検索システムに置いてもスコアリングは非常に大切なポイントです。重み付けを使いこなしたスコアリングができると、いかにも全文検索システムを作っているという実感が出て、楽しいと思います。</p>
</body>
</html>
