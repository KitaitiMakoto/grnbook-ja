<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="main.css" />
  <meta name="generator" content="Re:VIEW" />
  <title>データ入力機能の作成</title>
</head>
<body>
<h1><a id="h4"></a><span class="secno">第4章　</span>データ入力機能の作成</h1>
<p>ここからアプリケーションを作っていきます。始めから検索機能に着手したいところですが、データがないことには何もできないので、入力機能から作成します。</p>
<p>PDFファイルの内容をMySQLに登録するために、以下のようなステップを踏むことになります。</p>
<ol>
<li>PHPによるウェブUIから一時ディレクトリーにアップロードする</li>
<li>PDFファイルからタイトルと本文テキストを抽出する</li>
<li>タイトルと本文をMySQLの適切なカラムに挿入する</li>
</ol>

<h2><a id="h4-1"></a><span class="secno">4.1　</span>PDFのアップロード機能を作る</h2>
<p>まずはPDFのアップロード機能を作りましょう。PDFファイルその物は後で使うことはないので、一時ディレクトリーに置いたままで構いません。</p>
<p>ユーザーが表示させる起点の画面をindex.php、そのファイルから呼び出すアップロード機能の部分をupload.phpとして実装することにします。</p>
<div class="caption-code">
<p class="caption">リスト4.1: index.php</p>
<pre class="list language-php">&lt;?php
require_once __DIR__ . '/upload.php';

function h($string, $flags = ENT_QUOTES, $encoding = 'UTF-8')
{
    return htmlspecialchars($string, $flags, $encoding);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' &amp;&amp; array_key_exists('pdf', $_FILES)) {
    $uploads = \PDFSearch\Upload::fromFilesInfo($_FILES['pdf']);
}

?&gt;&lt;!doctype html&gt;
&lt;title&gt;PDF Search&lt;/title&gt;
&lt;h1&gt;PDF Search&lt;/h1&gt;

&lt;h2&gt;アップロードされたファイル&lt;/h2&gt;
&lt;?php if (! empty($uploads)): ?&gt;
&lt;?php foreach ($uploads as $upload): ?&gt;
&lt;p&gt;&lt;?php echo h($upload-&gt;getName()); ?&gt;&lt;/p&gt;
&lt;?php endforeach; ?&gt;
&lt;?php endif; ?&gt;

&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;
  &lt;input name=&quot;pdf[]&quot; type=&quot;file&quot; multiple&gt;
  &lt;input type=&quot;submit&quot;&gt;
&lt;/form&gt;
</pre>
</div>
<div class="caption-code">
<p class="caption">リスト4.2: upload.php</p>
<pre class="list language-php">&lt;?php
namespace PDFSearch;

class Upload
{
    protected $name;
    protected $tmpName;

    public static function fromFilesInfo(array $info)
    {
        $uploads = array();
        $fileCount = count($info['name']);
        for ($i = 0; $i &lt; $fileCount; $i++) {
            $name = $info['name'][$i];
            $tmpName = $info['tmp_name'][$i];
            $uploads[] = new Upload($name, $tmpName);
        }
        return $uploads;
    }

    public function __construct($name, $tmpName)
    {
        $this-&gt;name = $name;
        $this-&gt;tmpName = $tmpName;
    }

    public function getName()
    {
        return $this-&gt;name;
    }
}
</pre>
</div>
<p>今の所、単にアップロードされたファイルの名前を表示しているだけです。後でその他の機能を実装していきます。複数のファイルをアップロードすると<a id="fnb-multi-select" href="#fn-multi-select" class="noteref" epub:type="noteref">*1</a>、全てが表示されることも確認してみてください。</p>
<div id="upload" class="image">
<img src="images/ch04/upload.png" alt="ファイルアップロード画面" />
<p class="caption">
図4.1: ファイルアップロード画面
</p>
</div>
<p>紙幅を減らすため、細かな検証は省略しています。実際に運用するアプリケーションでは安全性やエラーのチェックなどをしっかりと行ってください。</p>
<p>また、エラーが表示されてしまった場合などPHPのでバッグが必要な場合は、本書末尾の「A.6 PHPのデバッグ」にデバッグ方法を記していますので、参考にされてください。</p>
<div class="footnote" epub:type="footnote" id="fn-multi-select"><p class="footnote">[*1] ファイル選択ダイアログでCtrlキーを押しながらファイルをクリックしていくことで、選んだファイルを同時にアップロードできます。また、Shiftを押しながら最初のファイルと最後のファイルをクリックすることで、その間にあるファイルをすべて選択状態にできます。なお、PHPの設定により、合計で1GiBを超えるアップロードは失敗します。</p></div>

<h2><a id="h4-2"></a><span class="secno">4.2　</span>PDFからの情報を抽出する</h2>
<p>次に、PDFファイルからタイトルと本文を抜き出す処理を実装します。これを行うにはいくつか方法がありますが、ここでは<a href="https://github.com/php-poppler/php-poppler" class="link">php-poppler</a>というライブラリーを使うことにします。php-popplerを使うとPDFを解析してタイトルや本文を抜き出すことができます<a id="fnb-poppler" href="#fn-poppler" class="noteref" epub:type="noteref">*2</a>。</p>
<p>php-popplerは<code class="inline-code tt">Poppler</code>名前空間にいくつかのクラスを定義しており、以下のようにして使います。</p>
<div class="emlist-code">
<p class="caption">php-popplerの基本的な使い方</p>
<pre class="emlist language-php">&lt;?php

// pdfinfoコマンドのラッパー
$pdfinfo = \Poppler\Driver\Pdfinfo::create();
// pdftotextコマンドのラッパー
$pdftotext = \Poppler\Driver\Pdftotext::create();
// pdftohtmlコマンドのラッパー
$pdftohtml = \Poppler\Driver\Pdftohtml::create();

$pdf = new \Poppler\Processer\Pdffile($pdfinfo, $pdftotet, $peftohtml);

// PDFからタイトルや著者、作成日時などの情報を連想配列として抜き出す
echo $pdf-&gt;getInfo('path/to/document.pdf');
// PDFから本文テキストを抜き出す
echo $pdf-&gt;toText('path/to/document.pdf');
</pre>
</div>
<p>HTML関連の機能を使わないとしても、<code class="inline-code tt">\Poppler\Processer\Pdffile</code>のコンストラクターには<code class="inline-code tt">\Poppler\Driver\Pdftohtml</code>のインスタンスを渡す必要があるので注意してください。</p>
<p>Dockerイメージの中には、既にPopplerとphp-popplerがインストール済みです。php-popplerはComposerでインストールしているので、<code class="inline-code tt">vendor/autoload.php</code>を読み込むことで、オートロードが有効になります。</p>
<p>これを使って、先ほど作った<code class="inline-code tt">\PDFSearch\Upload</code>クラスにPDF関連の機能を追加します。</p>
<div class="caption-code">
<p class="caption">リスト4.3: upload.php</p>
<pre class="list language-php">&lt;?php
namespace PDFSearch;

class Upload
{
    // :
    // （省略）
    // :
    public function __construct($name, $tmpName)
    {
        $this-&gt;name = $name;
        $this-&gt;tmpName = $tmpName;
        $this-&gt;pdf = new \Poppler\Processor\PdfFile(
          \Poppler\Driver\Pdfinfo::create(),
          \Poppler\Driver\Pdftotext::create(),
          \Poppler\Driver\Pdftohtml::create()
        );
    }
    // :
    // （省略）
    // :
    public function getTitle()
    {
        $info = $this-&gt;pdf-&gt;getInfo($this-&gt;tmpName);
        return $info['Title'];
    }

    public function getContent()
    {
        return $this-&gt;pdf-&gt;toText($this-&gt;tmpName);
    }
}
</pre>
</div>
<p>これに合わせ、index.phpの方も少し変更します。</p>
<div class="caption-code">
<p class="caption">リスト4.4: index.php</p>
<pre class="list language-php">&lt;?php
// Dockerイメージ内にComposerでインストール済みのライブラリーを読み込む
require_once 'vendor/autoload.php';
require_once __DIR__ . '/upload.php';
    // :
    // （省略）
    // :
&lt;?php // getName()をgetTitle()に変更します。 ?&gt;
&lt;p&gt;&lt;?php echo h($upload-&gt;getTitle()); ?&gt;(&lt;?php echo h($upload-&gt;getName()); ?&gt;)&lt;/p&gt;
&lt;p&gt;&lt;?php echo h(mb_substr($upload-&gt;getContent(), 0, 120)); ?&gt;&amp;hellip;&amp;hellip;&lt;/p&gt;
    // :
    // （省略）
    // :
</pre>
</div>
<p>実際にPDFファイルをアップロードして、タイトルなどの情報が取得できているか確認しましょう。</p>
<div id="extract" class="image">
<img src="images/ch04/extract.png" alt="PDF内の情報を取得" />
<p class="caption">
図4.2: PDF内の情報を取得
</p>
</div>
<div class="footnote" epub:type="footnote" id="fn-poppler"><p class="footnote">[*2] C製のPDFライブラリーでPopplerという物があり、PDFを扱う様々なコマンドラインツールの提供もしています。php-popplerはこれらのコマンド呼び出しをラップしてPHPから扱いやすくした物です。</p></div>

<h2><a id="h4-3"></a><span class="secno">4.3　</span>データベースにデータを挿入する</h2>
<p>それでは、いよいよMroongaにデータを入力しましょう。と言っても、いつも通り<code class="inline-code tt">PDO</code>クラスで<code class="inline-code tt">INSERT</code>文を実行するだけです。Mroongaの方で自動的に検索用のインデックスを作成してくれます。Dockerイメージ内に既にMySQL用のアダプターはインストールされていますので、単にPHPから呼び出すだけで使用できます。</p>
<p>データ挿入に必要なMySQLのデータベースとテーブルは、コンテナの中に既に作成してあります。構造は以下の通りです。</p>
<div class="emlist-code">
<p class="caption">テーブル作成時の全文検索インデックスの作成</p>
<pre class="emlist language-SQL">CREATE TABLE `pdfs` (
    id      INT PRIMARY KEY AUTO_INCREMENT,
    file    VARCHAR(255),
    title   VARCHAR(255),
    content LONGTEXT,
    FULLTEXT INDEX (title, content)
) ENGINE = Mroonga DEFAULT CHARSET utf8;
</pre>
</div>
<p><code class="inline-code tt">FULLTEXT INDEX</code>や<code class="inline-code tt">ENGINE = Mroonga</code>については後述しますので、ここではカラム定義に注目してください。</p>
<p>このテーブルを扱う<code class="inline-code tt">\PDFSearch\Table</code>クラスを実装し、<code class="inline-code tt">index.php</code>でそのクラスを使うようにしたのが以下の内容です。<code class="inline-code tt">\PDFSearch\Upload</code>には変更がないため省略しています。</p>
<div class="caption-code">
<p class="caption">リスト4.5: index.php</p>
<pre class="list language-php">&lt;?php
// Dockerイメージ内にComposerでインストール済みのライブラリーを読み込む
require_once 'vendor/autoload.php';
require_once __DIR__ . '/upload.php';
require_once __DIR__ . '/table.php';

define('DBNAME', 'pdfsearch');

$dsn = 'mysql:host=localhost;dbname=' . DBNAME . ';charset=utf8';
$table = new \PDFSearch\Table($dsn, 'root', '');

function h($string, $flags = ENT_QUOTES, $encoding = 'UTF-8')
{
    return htmlspecialchars($string, $flags, $encoding);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' &amp;&amp;
    array_key_exists('pdf', $_FILES)) {
    $uploads = \PDFSearch\Upload::fromFilesInfo($_FILES['pdf']);
    try {
        foreach ($uploads as $upload) {
            $table-&gt;insert($upload);
        }
        header('Location: .');
    } catch (\RuntimeException $e) {
        header('HTTP', true, 500);
        header('content-type: text/plain');
        echo $e;
    }
    exit;
}

$records = $table-&gt;records();

?&gt;&lt;!doctype html&gt;
&lt;title&gt;PDF Search&lt;/title&gt;
&lt;h1&gt;PDF Search&lt;/h1&gt;

&lt;h2&gt;登録済みPDF一覧&lt;/h2&gt;
&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;ファイル名&lt;/th&gt;
    &lt;th&gt;タイトル&lt;/th&gt;
    &lt;th&gt;内容&lt;/th&gt;
  &lt;/tr&gt;
  &lt;?php foreach ($records as $record): ?&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;?php echo h($record['file']); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo h($record['title']); ?&gt;&lt;/td&gt;
      &lt;td&gt;&lt;?php echo h(mb_substr($record['content'], 0, 120)); ?&gt;&amp;hellip;&amp;hellip;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;?php endforeach; ?&gt;
&lt;/table&gt;

&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;
  &lt;input name=&quot;pdf[]&quot; type=&quot;file&quot; multiple&gt;
  &lt;input type=&quot;submit&quot;&gt;
&lt;/form&gt;
</pre>
</div>
<div class="caption-code">
<p class="caption">リスト4.6: table.php</p>
<pre class="list language-php">&lt;?php
namespace PDFSearch;

class Table
{
    const INSERT =
        &quot;INSERT INTO `pdfs` (file, title, content)
         VALUES(:file, :title, :content);&quot;;
    const SELECT = &quot;SELECT * FROM `pdfs` ORDER BY `id`;&quot;;

    protected $pdo;

    public function __construct($dsn, $username, $password)
    {
        $this-&gt;pdo = new \PDO($dsn, $username, $password);
    }

    public function insert(Upload $upload)
    {
        $params = [
            ':file'    =&gt; $upload-&gt;getName(),
            ':title'   =&gt; $upload-&gt;getTitle(),
            ':content' =&gt; $upload-&gt;getContent()
        ];
        $sth = $this-&gt;pdo-&gt;prepare(self::INSERT);
        $isSucceeded = $sth-&gt;execute($params);
        if (! $isSucceeded) {
            throw new \RuntimeException(implode(PHP_EOL, $sth-&gt;errorInfo()));
        }
    }

    public function records()
    {
        $sth = $this-&gt;pdo-&gt;prepare(self::SELECT);
        $isSucceeded = $sth-&gt;execute();
        if (! $isSucceeded) {
            throw new \RuntimeException(implode(PHP_EOL, $sth-&gt;errorInfo()));
        }
        return $sth-&gt;fetchAll();
    }
}
</pre>
</div>
<p>ウェブブラウザーでアクセスして、データベースの中身を表示してみましょう。</p>
<div id="insert" class="image">
<img src="images/ch04/insert.png" alt="アップロードしたPDFの情報を表示" />
<p class="caption">
図4.3: アップロードしたPDFの情報を表示
</p>
</div>
</body>
</html>
